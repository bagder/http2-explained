# HTTP 2のコンセプト

HTTP 2は何を成し遂げたのでしょうか。HTTPbisはスコープの境界線をどこに引いたのでしょうか。

これらは極めて厳格であり、チームのイノベーションを厳しく制限するものでした。

- HTTPのパラダイムを保持しなければなりません。TCP上でクライアントがサーバーにリクエストを送信する形のプロトコルなのです。

- http://とhttps:// URLを変更することはできません。新しいスキームを導入することはできません。これらのURLを使うコンテンツは膨大でああるため、変更することができないのです。

- HTTP 1サーバーとクライアントはこれからも数十年にわたり存在し続けます。それらをHTTP 2サーバーにプロキシーする必要があります。

- そして、プロキシーはHTTP 2の機能をHTTP 1.1クライアントへ1:1で対応させなければなりません。

- プロトコルからオプショナルな部分を削除するか削減する。これは要求ではありませんが、SPDYやGoogleチームからやってきた信条のようなものです。すべてを必須にしてしまえば、今実装できないなため後で罠にはまる、といったようなことが起こりえないのです。

- マイナーバージョンを廃止します。クライアントとサーバーはHTTP 2に対応するか、対応していないかのどちらかです。プロトコルを拡張あるいは変更したいという要求が出た場合は、それはHTTP 3の出番です。HTTP 2にはマイナーバージョンはありません。

## 5.1. HTTP 2と既存のURIスキーム

以前に述べた通り、既存のURIスキームは変更することができないので、HTTP 2は既存のものを使わなければなりません。これらはHTTP 1.xで今日使われているため、プロトコルをHTTP 2へアップグレードする、あるいはサーバーに古いプロトコルではなくてHTTP 2を使ってくださいとお願いする必要があります。

HTTP 1.1はこのためのUpgradeヘッダーという機構を備えています。古いプロトコルでこのようなリクエストを受けた場合、サーバーが新しプロトコルで応答を返すというものです。しかしラウンドトリップのペナルティを受けます。

SPDYチームはラウンドトリップのペナルティを受け入れることができませんでした。彼らはSPDYをTLS上でのみ実装していたので、ネゴシエーションを大幅に簡略化するTLS拡張を開発しました。この拡張、Next Protocol Negotiation（NPN）を使うと、サーバーは、それがサポートするプロトコルをクライアントへ通知し、クライアントがプロトコルを選択することができます。

## 5.2. HTTP 2とhttps://

HTTP 2ではTLS上で適切に振る舞うように随所で配慮がなされました。SPDYはTLSが必須でしたし、HTTP 2ではTLSを必須にしようという大きな後押しがありました。しかしコンセンサスが得られず、HTTP 2ではTLSは必須ではなくなりました。しかしながら今をリードする2つのwebブラウザー、Mozilla FirefoxとGoogle Chromeの開発者はHTTP 2をTLS上でのみ実装すると明言しました。

TLSを選択する理由には、ユーザーのプライバシーを尊重するということと、新しいプロトコルを導入する際はTLSを使うほうが高い成功率があったという実測結果の存在がありました。80番ポートを通過するものはすべてHTTP 1.1であるという広く信じられている前提があり、中間装置によっては通信を妨害したり遮断したりして、他のプロトコルが機能することを妨げるのです。

TLSを必須にするかどうかは、メイリングリストやミーティングで根強い反対意見が寄せられました。これは善なのか悪なのか、ということです。これは呪われた議題です。HTTPbis参加者に向かってこの質問をするときは注意してください。

同様にHTTP 2はTLSを使用する場合の必須暗号化スイートのリストを宣言すべきかどうか、あるいは、使用できないものをブラックリストにすべきか、いやいや、TLS"層"に要求することはせず、すべてTLS WGに任せようではないか、といった白熱した議論がかわされました。最終的にはTLS 1.2以上を必須とし、暗号化スイートに制限を付ける、ということになりました。

## 5.3. TLSにおけるHTTP 2ネゴシエーション

Next Protocol Negotiation（NPN）はTLSサーバーとSPDYをネゴシエートするプロトコルです。それは標準化されていなかったので、IETFで議論した結果、Application Layer Protocol Negotiation（ALPN）が生まれました。ALPNはHTTP 2で使われることになり、SPDYクライアントとサーバーはNPNを使い続けています。

NPNのほうが最初に登場したこと、またALPNが標準化に時間を取られたこともあって、初期のHTTP 2クライアントとサーバー実装はHTTP 2をネゴシエートする時に両方の拡張を使うようになりました。またNPNはSPDYで使用されていて多くのサーバーがSPDYとHTTP 2を両方サポートすることから、NPNとALPNをこれらのサーバーでサポートすることは理にかなっています。

ALPNとNPNの主たる差異はどちらがプロトコルを選択するかということです。ALPNではクライアントがサーバーに優先度の高い順にソートしたプロトコルのリストを渡し、サーバーがその中から選択しますが、NPNではクライアントが最終的な決定をします。

## 5.4. HTTP 2とhttp://

先に述べたとおり、平文HTTP 1.1においてHTTP 2をネゴシエートするにはサーバーにUpgradeヘッダーを送信します。サーバーがHTTP 2をサポートするなら、”101 Switching”ステータスを返し、その接続においては以後HTTP 2を使用します。もちろんこのアップグレード手順はネットワークの完全な1ラウンドトリップを必要とします。しかし利点としてはHTTP 2は永続的接続であり一般的にHTTP 1接続よりも多くの部分を再利用可能です。

いくつかのブラウザーベンダーはこの方法でのHTTP 2の使用を実装しないと言っていますが、Internet Explorerチームは実装する意思を示していて、またcurlはすでにサポートしています。
